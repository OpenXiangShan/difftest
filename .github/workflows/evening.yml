name: Evening Regression

on:
  schedule:
    # 12:00 UTC == 20:00 UTC+8
    - cron: '00 12 * * *'

  # Delete after the PR test is passed.
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  test-fpga-nutshell:
    if: ${{ github.event_name == 'pull_request' }}
    timeout-minutes: 1440
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Prepare NutShell
        run: |
          cd $GITHUB_WORKSPACE/..
          rm -rf NutShell && rm -rf env-scripts
          proxychains git clone -b dev-difftest --single-branch --depth 1 https://github.com/OSCPU/NutShell.git
          cd NutShell && make init && rm -rf difftest && cp -r $GITHUB_WORKSPACE .
          echo "NOOP_HOME=$(pwd)" >> $GITHUB_ENV
          echo "DIFF_HOME=$NOOP_HOME/difftest/" >> $GITHUB_ENV
          echo "DUT_HOME=$(pwd)" >> $GITHUB_ENV
          echo "/nfs/home/tools/Xilinx/Vivado/2020.2/bin" >> "$GITHUB_PATH"

      - name: Prepare FPGA scripts
        run: |
          cd $GITHUB_WORKSPACE/..
          proxychains git clone -b dev_difftest --single-branch --depth 1 https://github.com/OpenXiangShan/env-scripts.git
          cd env-scripts
          echo "ENV_SCRIPTS_HOME=$(pwd)" >> $GITHUB_ENV

      - name: Build NutShell
        run: |
          cd $NOOP_HOME
          make verilog BOARD=fpgadiff MILL_ARGS="--difftest-config ESBIF" -j2 
          cp -i ./difftest/src/test/vsrc/fpga/fpga_clock_gate.v ./build/rtl/

      - name: Create FPGA project
        run: |
          source /nfs/home/tools/Xilinx/Vivado/2020.2/settings64.sh
          cd $GITHUB_WORKSPACE/../env-scripts/fpga_diff
          make update_core_flist CORE_DIR=$DUT_HOME
          make vivado CPU=nutshell

      - name: Build FPGA synth
        run: |
          source /nfs/home/tools/Xilinx/Vivado/2020.2/settings64.sh
          cd $ENV_SCRIPTS_HOME/fpga_diff
          make synth PRJ=fpga_nutshell/fpga_nutshell.xpr
          bash ./tools/generate_reports.sh nutshell

      - name: Extract Vivado Hierarchical utilization
        run: |
          set -euo pipefail
          IN_PATH="$ENV_SCRIPTS_HOME/fpga_diff/"
          OUT_PATH="$RUNNER_TEMP/vivado_hier.md"
          python3 "$GITHUB_WORKSPACE/scripts/fpga_sim/ci.py" --input "$IN_PATH" --output "$OUT_PATH" --format markdown --cpu nutshell
          echo "VIVADO_HIER_MD=$OUT_PATH" >> "$GITHUB_ENV"

      - name: Comment utilization to PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        env:
          VIVADO_HIER_MD: ${{ env.VIVADO_HIER_MD }}
        with:
          script: |
            const fs = require('fs');
            let body;
            try {
              body = fs.readFileSync(process.env.VIVADO_HIER_MD, 'utf8');
              if (!body.trim()) throw new Error('empty');
            } catch (e) {
              body = 'Vivado Hierarchical utilization: section missing or extract failed. Please check the job logs for runme.log output.';
            }
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });

  test-fpga-xiangshan-miniconfig:
    if: ${{ github.event_name == 'schedule' }}
    timeout-minutes: 1440
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Prepare XiangShan
        run: |
          cd $GITHUB_WORKSPACE/..
          rm -rf XiangShan && rm -rf env-scripts
          proxychains git clone --depth 1 https://github.com/OpenXiangShan/XiangShan.git
          cd XiangShan && make init && rm -rf difftest && cp -r $GITHUB_WORKSPACE .
          echo "NOOP_HOME=$(pwd)" >> $GITHUB_ENV
          echo "DIFF_HOME=$NOOP_HOME/difftest/" >> $GITHUB_ENV
          echo "DUT_HOME=$(pwd)" >> $GITHUB_ENV

      - name: Prepare FPGA scripts
        run: |
          cd $GITHUB_WORKSPACE/..
          proxychains git clone --depth 1 https://github.com/OpenXiangShan/env-scripts.git

      - name: Build Xiangshan
        run: |
          cd $NOOP_HOME
          make verilog CONFIG=FpgaDiffMinimalConfig PLDM=1 FPGA_DIFF=1 PLDM_ARGS="--difftest-config H" -j16 JVM_XMX=10G
          python $NOOP_HOME/difftest/scripts/st_tools/interface.py $DUT_HOME/build/rtl/XSTop.sv --core --fpga
          NOOP_HOME=$NOOP_HOME/difftest/
          make difftest_verilog PROFILE=$DIFF_HOME/build/generated-src/difftest_profile.json NUM_CORES=1 CONFIG=ESBIF
          python $DIFF_HOME/scripts/st_tools/interface.py $DIFF_HOME/build/rtl/GatewayEndpoint.sv
          cp -r $DIFF_HOME/src/test/vsrc/fpga $DUT_HOME/build/
          cp -r $DIFF_HOME/build $DUT_HOME

      - name: Create FPGA project
        run: |
          PATH=$PATH:/nfs/home/tools/Xilinx/Vivado/2020.2/bin
          source /nfs/home/tools/Xilinx/Vivado/2020.2/settings64.sh
          cd $GITHUB_WORKSPACE/../env-scripts/fpga_diff
          make update_core_flist CORE_DIR=$DUT_HOME
          make vivado CPU=xiangshan

      - name: Build FPGA synth
        run: |
          cd $GITHUB_WORKSPACE/../env-scripts/fpga_diff
          make synth PRJ=fpga_xiangshan/fpga_xiangshan.xpr
          bash ./tools/generate_reports.sh xiangshan

      - name: Print Vivado Hierarchical utilization to logs
        run: |
          set -euo pipefail
          IN_PATH="${IN_PATH:-$GITHUB_WORKSPACE/../env-scripts/fpga_diff/vivado-analyse.txt}"
          echo "===== Vivado Hierarchical utilization ====="
          # Use unified extractor; it will print env-scripts logs and fail if section missing
          python3 "$GITHUB_WORKSPACE/scripts/fpga_sim/ci.py" --input "$IN_PATH" --format markdown --cpu xiangshan